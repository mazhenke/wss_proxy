# WSS Shadowsocks 插件 - 快速使用指南

## 项目说明

这是一个基于 WebSocket (WSS) 的 Shadowsocks SIP003 插件，用 Python 实现。

**主要特性：**
- ✅ 支持 WSS (WebSocket over TLS) 传输
- ✅ 数据加扰混淆（XOR + 随机填充 + 字节重排）
- ✅ 完全符合 SIP003 标准
- ✅ 纯 Python 实现，易于理解和修改

## 文件清单

```
核心程序：
├── wss_plugin_client.py    # 客户端插件
├── wss_plugin_server.py    # 服务端插件
└── obfuscator.py           # 数据加扰模块

配置示例：
├── config_client_example.json
├── config_server_example.json
├── test_client.sh
└── test_server.sh

文档：
├── README_wss_plugin.md    # 详细文档（英文）
├── QUICKSTART.md          # 快速入门（英文）
├── PROJECT_SUMMARY.md     # 项目总结
└── 使用说明.md            # 本文件
```

## 快速开始

### 第一步：测试加扰模块

```bash
python3 obfuscator.py
```

看到所有测试通过（✓ Success）即表示正常。

### 第二步：准备 SSL 证书

**测试环境（自签名证书）：**
```bash
openssl req -x509 -newkey rsa:4096 -nodes \
  -keyout privkey.pem -out fullchain.pem -days 365 \
  -subj "/CN=localhost"
```

**生产环境（Let's Encrypt）：**
```bash
sudo certbot certonly --standalone -d your_domain.com
sudo cp /etc/letsencrypt/live/your_domain.com/fullchain.pem .
sudo cp /etc/letsencrypt/live/your_domain.com/privkey.pem .
sudo chown $USER:$USER *.pem
```

### 第三步：本地测试

#### 测试准备

需要先安装 Shadowsocks（选择其一）：

```bash
# Ubuntu/Debian
sudo apt-get install shadowsocks-libev

# 或使用 shadowsocks-rust
# 从 https://github.com/shadowsocks/shadowsocks-rust/releases 下载
```

#### 启动测试

**终端 1 - SS 服务器：**
```bash
cat > ss_test.json << EOF
{
  "server": "127.0.0.1",
  "server_port": 8388,
  "password": "test123",
  "method": "aes-256-gcm"
}
EOF

ss-server -c ss_test.json
```

**终端 2 - WSS 服务端：**
```bash
./test_server.sh
```

**终端 3 - WSS 客户端：**
```bash
./test_client.sh
```

**终端 4 - 测试连接：**
```bash
# 测试代理是否工作
curl -x socks5h://127.0.0.1:1080 https://ipinfo.io

# 应该看到服务器的 IP 信息
```

### 第四步：实际部署

#### 服务器配置

**1. 启动 Shadowsocks 服务器**
```bash
# 编辑配置
sudo nano /etc/shadowsocks/config.json

{
  "server": "127.0.0.1",
  "server_port": 8388,
  "password": "你的强密码",
  "method": "aes-256-gcm"
}

# 启动
ss-server -c /etc/shadowsocks/config.json
```

**2. 启动 WSS 插件服务端**

编辑 `test_server.sh` 修改配置：
```bash
export SS_REMOTE_HOST=127.0.0.1      # SS 后端地址
export SS_REMOTE_PORT=8388           # SS 后端端口
export SS_LOCAL_HOST=0.0.0.0         # 监听地址
export SS_LOCAL_PORT=443             # 监听端口（WSS）
export SS_PLUGIN_OPTIONS="wss_path=/ws;cert=fullchain.pem;key=privkey.pem;obfs_key=你的加扰密钥"
```

运行：
```bash
./test_server.sh
# 或后台运行
nohup ./test_server.sh > wss_server.log 2>&1 &
```

#### 客户端配置

编辑 `test_client.sh`：
```bash
export SS_REMOTE_HOST=你的服务器IP        # 服务器地址
export SS_REMOTE_PORT=443               # 服务器端口
export SS_LOCAL_HOST=127.0.0.1          # 本地监听
export SS_LOCAL_PORT=1080               # 本地端口
export SS_PLUGIN_OPTIONS="wss_host=你的服务器IP;wss_port=443;wss_path=/ws;skip_cert_verify=true;obfs_key=你的加扰密钥"
```

运行：
```bash
./test_client.sh
```

测试：
```bash
curl -x socks5h://127.0.0.1:1080 https://www.google.com
```

## 重要配置说明

### 加扰密钥 (obfs_key)

**必须确保客户端和服务端的 obfs_key 完全一致！**

建议使用长随机字符串：
```bash
# 生成随机密钥
openssl rand -base64 32
# 输出类似：A7sK9mP3vX8wQ2nT5yR6hJ1dF4gL0zC8eB9uM7pN3tV=
```

### SSL 证书验证

**测试环境：**
```bash
skip_cert_verify=true   # 跳过证书验证
```

**生产环境：**
```bash
skip_cert_verify=false  # 启用证书验证（需要有效证书）
```

### WebSocket 路径

可以自定义路径来伪装流量：
```bash
wss_path=/ws           # 默认
wss_path=/api/ws       # 伪装成 API
wss_path=/static/js    # 伪装成静态资源
```

## 配合 Shadowsocks 使用

### 方式一：作为独立插件

直接运行插件脚本，然后配置 Shadowsocks 连接到插件端口。

### 方式二：集成到 Shadowsocks 配置

**服务端配置文件：**
```json
{
  "server": "0.0.0.0",
  "server_port": 8388,
  "password": "你的密码",
  "method": "aes-256-gcm",
  "plugin": "/path/to/wss_plugin_server.py",
  "plugin_opts": "wss_port=443;obfs_key=你的密钥"
}
```

**客户端配置文件：**
```json
{
  "server": "服务器IP",
  "server_port": 443,
  "local_port": 1080,
  "password": "你的密码",
  "method": "aes-256-gcm",
  "plugin": "/path/to/wss_plugin_client.py",
  "plugin_opts": "obfs_key=你的密钥"
}
```

## 常见问题

### Q: 客户端连接失败？
**A:** 检查：
1. 服务器防火墙是否开放端口
2. obfs_key 是否一致
3. 证书是否正确

### Q: 数据传输有问题？
**A:** 确认：
1. obfs_key 完全一致（区分大小写）
2. wss_path 路径一致
3. 查看日志找出具体错误

### Q: 性能如何？
**A:** 
- 加扰开销约 5-10%
- 主要瓶颈在网络带宽
- 适合一般使用场景

### Q: 如何查看日志？
**A:** 
程序会在终端输出详细日志：
```
INFO - 连接信息
DEBUG - 数据传输详情
ERROR - 错误信息
```

可以重定向到文件：
```bash
./test_server.sh > server.log 2>&1
```

## 数据加扰原理

```
原始数据（例如 100 字节）
    ↓
添加 2 字节长度头 + 1-15 字节随机填充
    ↓
使用 256 字节密钥流进行 XOR
    ↓
按 4 字节块进行字节反转
    ↓
输出加扰数据（约 103-117 字节）
```

这样可以：
- 打破固定长度特征
- 混淆数据内容
- 增加流量识别难度

## 性能优化建议

1. **调整缓冲区大小**
   编辑源代码，修改 `reader.read(8192)` 为更大值

2. **关闭调试日志**
   修改 `logging.INFO` 为 `logging.WARNING`

3. **系统参数优化**
   ```bash
   ulimit -n 65535
   sudo sysctl -w net.core.rmem_max=16777216
   ```

## 进阶使用

### 配合 CDN 使用

可以将 WSS 服务器放在 CDN 后面：

1. 使用 Cloudflare 等支持 WebSocket 的 CDN
2. 配置域名和证书
3. 客户端连接 CDN 域名

### Systemd 服务

创建 `/etc/systemd/system/wss-plugin.service`：
```ini
[Unit]
Description=WSS Plugin
After=network.target

[Service]
Type=simple
User=nobody
Environment="SS_REMOTE_HOST=127.0.0.1"
Environment="SS_REMOTE_PORT=8388"
Environment="SS_LOCAL_HOST=0.0.0.0"
Environment="SS_LOCAL_PORT=443"
Environment="SS_PLUGIN_OPTIONS=obfs_key=你的密钥"
ExecStart=/usr/bin/python3 /opt/wss_plugin_server.py
Restart=always

[Install]
WantedBy=multi-user.target
```

启动：
```bash
sudo systemctl enable wss-plugin
sudo systemctl start wss-plugin
sudo systemctl status wss-plugin
```

## 安全建议

1. ✅ 使用强随机密码和加扰密钥
2. ✅ 生产环境使用有效 SSL 证书
3. ✅ 定期更换密钥
4. ✅ 监控服务器日志
5. ✅ 及时更新系统和软件

## 获取帮助

- 查看详细文档：`README_wss_plugin.md`
- 查看快速入门：`QUICKSTART.md`
- 查看项目总结：`PROJECT_SUMMARY.md`

## 技术支持

遇到问题时：
1. 先查看日志输出
2. 确认配置正确
3. 测试网络连接
4. 检查防火墙设置

---

**祝使用愉快！**
